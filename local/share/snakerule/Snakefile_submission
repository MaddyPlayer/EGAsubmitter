include: "../snakemake/conf_submission.sk"


### --------Preparation part-------- ###
rule all:
    input: DONE+"/dataset.done"
    output: DONE+"/AllSubmissions.done"
    shell:
        """
            echo "All done:
            Please, check on the web page
            https://ega-archive.org/submitter-portal/#/login
            if everything is fine, you shall proceed with the validation"
            touch {output}
        """
### Converts all the yaml files given by the user: the user must place all the files in the yaml/ folder, after filling them out
rule allYaml:
    input: expand(USER_METADATA+"/json/{what}.json", what=FILES)
    output: touch(DONE+"/yamlConversion.done")
    shell: 'echo "All .yaml files have been converted to .json"'
rule yamlConversion:
    input: yaml=ancient(USER_METADATA+"/yaml/{what}.yaml")
    output: json=USER_METADATA+"/json/{what}.json" 
    run:
        import os
        import ruamel.yaml
        import json 
        yaml = ruamel.yaml.YAML(typ='safe')
        with open(input.yaml) as yaml_in, open(output.json, "w") as json_out:
            yaml_object = yaml.load(yaml_in)
            json.dump(yaml_object, json_out, indent=1)
### ---- ###

### TODO: in theory, this rule should depend on an output done by the egacryptor portion
checkpoint buildRuns:
    input: doneYaml=ancient(DONE+"/yamlConversion.done"), encrypted=ancient(TRANSFER+"/logs/done/filesCrypted.done")
    output: csv=SAMPLES_PATH+"/SamplesInformations.csv", done=DONE+"/buildRuns.done", samples=SAMPLES_PATH+"/Allfiles_list.txt", runs=RUNS_PATH+"/Allfiles_list.txt", allsamples=USER_METADATA+"/AllSamples_list.txt"#, exps=EXPS_PATH+"/AllExps_list.txt"
    params: path=DATASET, runType=FILETYPE, encryptedFiles=PROJECT_NAME # TODO given by the user?
    script: SRC_DIR + "/Runs_build.R"

### This rule will build all the {samples}.json
rule buildSamples:
    input: getJson
    output: done=DONE+"/buildSamples.done"
    shell:
        """
            touch {output.done}
            echo "All samples.json have been built"
        """
rule samples:
    input: csv=ancient(SAMPLES_PATH+"/SamplesInformations.csv"), donebR=ancient(DONE+"/buildRuns.done")
    output: json=SAMPLES_PATH+"/{sample}.json", done=DONE+"/samples/json/{sample}.json.done"
    run:
        import json
        import csv
        primary_fields = ['alias', 'title', 'description', 'caseOrControlId', 'genderId',
        'organismPart', 'cellLine', 'region', 'phenotype', 'subjectId', 'anonymizedName', 'bioSampleId', 'sampleAge',
        'sampleDetail']
        with open(input.csv) as csv_file:
            reader = csv.DictReader(csv_file, skipinitialspace=True, delimiter=",")
            for row in reader:
                sample = row['alias']
                d = {k: v for k, v in row.items() if k in primary_fields}
                d['attributes'] = [{'tag': row['attributes.tag'], 'value': row['attributes.value']}]
                jsonString = json.dumps(d, indent=2)
                jsonFile = open(SAMPLES_PATH+"/"+sample+".json", "w")
                jsonFile.write(jsonString)
                jsonFile.close()
        open(output.done, 'a').close()

rule sub1:
    input: json=ancient(DATA+"/SubmissionSubsetTemplate.json"), doneSamples=ancient(DONE+"/buildSamples.done")
    output: submission=SUBMISSION_PATH+"/Submission.json", done=DONE+"/sub1.done"
    params: path=DATASET, idbckup=IDBCKUP
    script: SRC_DIR+"/Submission_builder.R"
### --------Preparation part-------- ###

### --------Submission.json part-------- ###
rule submission:
    input: token=ancient("dataset/SessionToken"), json=ancient(SUBMISSION_PATH+"/Submission.json"), done=ancient(DONE+"/sub1.done")# This is the submission file with only title and description
    params: path=EGA_URL+"/submissions", idbckup=IDBCKUP
    output: id=SUBMISSION_PATH+"/SubmissionID", done=DONE+"/submission.done"
    log: SUB_LOGS+"/Submission_info.log",
    shell:
        """
            token=$(cat {input.token})
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST {params.path} -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Submission of Submission.json failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            now=$(date +"%d_%m_%Y")
            cp {output.id} {output.id}_$now
            mv {output.id}_$now {params.idbckup}
            echo "Submission ID has been saved in {params.idbckup}"
            echo "Submission.json has been submitted"
        """

### STUDY ###
rule study:
    input: token=ancient("dataset/SessionToken"), json=ancient(USER_METADATA+"/json/Study.json"), id=ancient(SUBMISSION_PATH+"/SubmissionID"), done=ancient(DONE+"/submission.done")
    params: path=EGA_URL
    output: id=IDS+"/StudyID", done=DONE+"/study.done"
    log: SUB_LOGS+"/Study_submission.log"
    shell:
        """ 
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/studies
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Submission of Study.json failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "Study.json has been submitted"
        """
### --- ###

### SAMPLES ###
rule allSamples:
    input: getSample
    output: done=DONE+"/allSamples.done"
    shell:
        """
            touch {output.done}
            echo "All samples have been submitted"
        """
### TODO: put a countdown?
rule samplesSubmission:
    input: token=ancient("dataset/SessionToken"), json=ancient(SAMPLES_PATH+"/{sample}.json"), id=ancient(SUBMISSION_PATH+"/SubmissionID"), doneStudy=ancient(DONE+"/study.done")
    params: path=EGA_URL
    output: id=SAMPLES_PATH+"/IDs/{sample}_ID", done=DONE+"/samples/{sample}-sampleSubmission.done"
    log: SUB_LOGS+"/samples/{sample}.log"
    shell:
        """
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/samples
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Submission of {wildcards.sample}.json failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "{wildcards.sample}.json has been submitted"
        """
### --- ###

        
rule experimentAlias:
    input: json=ancient(USER_METADATA+"/json/Experiment.json"), idStudy=IDS+"/StudyID", doneStudy=ancient(DONE+"/study.done"), doneAllSamples=ancient(DONE+"/allSamples.done")
    output: after=SUBMISSION_PATH+"/Experiment.json", done=DONE+"/experimentAlias.done"
    run:
        import json
        with open(input.idStudy) as i:
            id = i.readline().strip()
        with open(input.json) as file:
            df = json.load(file)
            df['studyId'] = id
        with open(output.after, 'w') as json_file:
            json.dump(df, json_file, indent=2)
        open(output.done, 'a').close()
###
rule experimentSubmission:
    input: token=ancient("dataset/SessionToken"), json=SUBMISSION_PATH+"/Experiment.json", id=ancient(SUBMISSION_PATH+"/SubmissionID"), doneExpAl=ancient(DONE+"/experimentAlias.done")
    params: path=EGA_URL
    output: id=SUBMISSION_PATH+"/IDs/Experiment_ID", done=DONE+"/experimentSubmission.done"
    log: SUB_LOGS+"/experimentSubmission.log"
    shell:
        """ 
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/experiments
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Submission of Study.json failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "Experiment.json has been submitted"
        """
### --- ###

### RUNS ###
rule allRuns:
    input: getRun
    output: done=DONE+"/allRuns.done"
    shell:
        """
            touch {output.done}
            echo "All runs have been submitted"
        """
###
rule runsAlias:
    input: json=ancient(RUNS_PATH+"/Run_{sample}.json"), idExp=SUBMISSION_PATH+"/IDs/Experiment_ID", idSample=SAMPLES_PATH+"/IDs/{sample}_ID", doneExp=ancient(DONE+"/experimentSubmission.done"), doneSample=ancient(DONE+"/allSamples.done")
    output: after=SUBMISSION_PATH+"/runs/Run_{sample}.json", done=DONE+"/runs/alias/runsAlias_{sample}.done"
    run:
        import json
        with open(input.idExp) as i, open(input.idSample) as s:
            id = i.readline().strip()
            sample = s.readline().strip()
        with open(input.json) as file:
            df = json.load(file)
            df['experimentId'] = id
            df['sampleId'] = sample
        with open(output.after, 'w') as json_file:
            json.dump(df, json_file, indent=2)
        open(output.done, 'a').close()
###
rule runsSubmission:
    input: token=ancient('dataset/SessionToken'), json=SUBMISSION_PATH+"/runs/Run_{sample}.json", id=ancient(SUBMISSION_PATH+"/SubmissionID"), donerunsAlias=ancient(DONE+"/runs/alias/runsAlias_{sample}.done")
    params: path=EGA_URL
    output: id=RUNS_PATH+"/IDs/Run_{sample}_ID", done=DONE+"/runs/{sample}-runSubmission.done"
    log: SUB_LOGS+"/runs/Run_{sample}.log"
    shell:
        """
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/runs
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Submission of Run_{wildcards.sample}.json failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "Run_{wildcards.sample}.json has been submitted"
        """
### --- ###

### DAC & Policy ###
rule dac:
    input: token=ancient('dataset/SessionToken'), json=ancient(USER_METADATA+"/json/DAC.json"), id=ancient(SUBMISSION_PATH+"/SubmissionID"), doneRuns=ancient(DONE+"/allRuns.done")
    params: path=EGA_URL
    output: id=IDS+"/DACID", done=DONE+"/dac.done"
    log: SUB_LOGS+"/DAC_submission.log"
    shell:
        """ 
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/dacs
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "DAC upload failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "DAC.json has been submitted"
        """
rule policyAlias:
    input: json=ancient(USER_METADATA+"/json/Policy.json"), idDAC=IDS+"/DACID", doneDAC=ancient(DONE+"/dac.done")
    output: after=SUBMISSION_PATH+"/Policy.json", done=DONE+"/policyAlias.done"
    run:
        import json
        with open(input.idDAC) as i:
            id = i.readline().strip()
        with open(input.json) as file:
            df = json.load(file)
            df['dacId'] = id
        with open(output.after, 'w') as json_file:
            json.dump(df, json_file, indent=2)
        open(output.done, 'a').close()
rule policy:
    input: token=ancient('dataset/SessionToken'), json=SUBMISSION_PATH+"/Policy.json", done=ancient(DONE+"/policyAlias.done"), id=ancient(SUBMISSION_PATH+"/SubmissionID")
    params: path=EGA_URL
    output: id=IDS+"/PolicyID", done=DONE+"/policy.done"
    log: SUB_LOGS+"/Policy_submission.log"
    shell:
        """ 
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/policies
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Policy upload failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "Policy.json has been submitted"
        """
### --- ###

### DATASET ###
rule datasetAlias:
    input: json=ancient(USER_METADATA+"/json/Dataset.json"), idPolicy=IDS+"/PolicyID", done=ancient(DONE+"/policy.done")
    params: runIDpath=ancient(RUNS_PATH+"/IDs/")
    output: after=SUBMISSION_PATH+"/Dataset.json", done=DONE+"/datasetAlias.done"
    run:
        import json
        import os
        with open(input.json) as file:
            df = json.load(file)
        file = os.listdir(params.runIDpath)
        for filename in file:
            if filename.endswith("_ID"):
                with open(os.path.join(params.runIDpath, filename), 'r') as f:
                    runID = f.readline().strip()
                    df['runsReferences'].append(runID)
        with open(input.idPolicy) as i:
            id = i.readline().strip()
            df['policyId'] = id
        with open(output.after, 'w') as json_file:
            json.dump(df, json_file, indent=2)
        open(output.done, 'a').close()
rule dataset:
    input: token=ancient('dataset/SessionToken'), json=SUBMISSION_PATH+"/Dataset.json", id=ancient(SUBMISSION_PATH+"/SubmissionID"), done=ancient(DONE+"/datasetAlias.done")
    params: path=EGA_URL
    output: id=IDS+"/DatasetID", done=DONE+"/dataset.done"
    log: SUB_LOGS+"/Dataset_submission.log"
    shell:
        """ 
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})/datasets
            curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
            jq -r '.response.result[0].id' {log} > {output.id}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Dataset upload failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            touch {output.done}
            echo "Dataset.json has been submitted"
        """
### --- ###
### --------Submission part-------- ###

### Add all the IDs to the submission project ###
# rule fill_IDs:
#     input: json=ancient(SUBMISSION_PATH+"/Submission.json")
#     output: after=SUBMISSION_PATH+"/SubmissionForValidationAndSubmission.json", done=DONE+"/fill_IDs.done"
#     params: studyID=IDS+"/StudyID", samplesID=SAMPLES_PATH+"/IDs", experimentID=IDS+"/Experiment_ID", runsID=RUNS_PATH+"/IDs", dacID=IDS+"/DACID", policyID=IDS+"/PolicyID", datasetID=IDS+"/DatasetID"
#     run:
#         import json
#         import os
#         with open(input.json) as file:
#             df = json.load(file)
#         with open(params.studyID) as s, open(params.experimentID) as e, open(params.datasetID) as d, open(params.policyID) as p, open(params.dacID) as dac:
#             df["submissionSubset"]["dacIds"].append(dac.readline().strip())
#             df["submissionSubset"]["datasetIds"].append(d.readline().strip())
#             df["submissionSubset"]["policyIds"].append(p.readline().strip())
#             df["submissionSubset"]["experimentIds"].append(e.readline().strip())
#             df["submissionSubset"]["studyIds"].append(s.readline().strip())
#         for filename in os.listdir(params.samplesID):
#             with open(os.path.join(params.samplesID, filename), 'r') as f:
#                 df['submissionSubset']['sampleIds'].append(f.readline().strip())
#         for filename in os.listdir(params.runsID):
#             with open(os.path.join(params.runsID, filename), 'r') as f:
#                 df['submissionSubset']['runIds'].append(f.readline().strip())
#         with open(output.after, 'w') as json_file:
#             json.dump(df, json_file, indent=2)
#         open(output.done, 'a').close()

### EXPERIMENT ###    link one experiment per sample: not needed, but better tp keep it
# rule allExperiments:
#     input: getExps
#     output: done=DONE+"/allExperiments.done"
#     shell:
#         """
#             touch {output.done}
#             echo "All experiments have been submitted"
#         """
###
# rule experimentAlias:
#     input: json=USER_METADATA+"/json/Experiment.json", idStudy=IDS+"/StudyID", idSample=SAMPLES_PATH+"/IDs/{sample}_ID", doneStudy=DONE+"/study.done", doneAllSamples=DONE+"/allSamples.done"
#     output: after=SUBMISSION_PATH+"/exps/Experiment_{sample}.json", done=DONE+"/exps/alias/experimentAlias_{sample}.done"
#     run:
#         import json
#         with open(input.idStudy) as i, open(input.idSample) as s:
#             id = i.readline().strip()
#             sample = s.readline().strip()
#         with open(input.json) as file:
#             df = json.load(file)
#             df['studyId'] = id
#             df['sampleId'] = sample
#         with open(output.after, 'w') as json_file:
#             json.dump(df, json_file, indent=2)
#         open(output.done, 'a').close()
# ###
# rule experimentSubmission:
#     input: token=ancient("SessionToken"), json=SUBMISSION_PATH+"/exps/Experiment_{sample}.json", id=SUBMISSION_PATH+"/SubmissionID", doneExpAl=DONE+"/exps/alias/experimentAlias_{sample}.done"
#     params: path=EGA_URL
#     output: id=EXPS_PATH+"/IDs/Experiment_{sample}_ID", done=DONE+"/exps/{sample}-experimentSubmission.done"
#     log: SUB_LOGS+"/exps/Experiment_{sample}.log"
#     shell:
#         """ 
#             token=$(cat {input.token})
#             path={params.path}/submissions/$(cat {input.id})/experiments
#             curl -H "Content-type: application/json" -H "X-Token: $token" -X POST $path -d @{input.json} > {log}
#             jq -r '.response.result[0].id' {log} > {output.id}
#             error=($(jq -r '.header.errorCode' {log}))
#             if [ "$error" -ne 1 ]; then
#                 echo "Submission of Study.json failed. The reason probably is:"
#                 jq -r '.header.userMessage' {log}
#                 exit 1
#             fi
#             touch {output.done}
#             echo "Experiment_{wildcards.sample}.json has been submitted"
#         """
