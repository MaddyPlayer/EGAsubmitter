include: "../snakemake/conf_submission.sk"


### Validation ###
rule validate:
    input: token=ancient('dataset/SessionToken'), id=SUBMISSION_PATH+"/SubmissionID", AllDone=DONE+"/AllSubmissions.done"#, json=SUBMISSION_PATH+"/SubmissionForValidationAndSubmission.json"
    params: path=EGA_URL
    output: done=DONE+"/validation.done"
    log: SUB_LOGS+"/validation.log"
    shell:
        """
            token=$(cat {input.token})
            path={params.path}/submissions/$(cat {input.id})?action=VALIDATE
            curl -H "X-Token: $token" -X PUT $path > {log}
            error=($(jq -r '.header.errorCode' {log}))
            if [ "$error" -ne 1 ]; then
                echo "Validation failed. The reason probably is:"
                jq -r '.header.userMessage' {log}
                exit 1
            fi
            error=($(jq -r '.response.result[0].status' {log}))
            if [ "$error" != "VALIDATE"]; then
                echo "The validation was successfull, but it still needs your attention, because:"
                jq -r '.response.result[0].validationError' {log}
                echo "Please, go to the submission page and check it: https://ega-archive.org/submitter-portal/#/login"
            else
                echo "Validation was successfull"
            fi
            touch {output.done}
        """
